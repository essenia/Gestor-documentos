<div class="container mt-4">
  <h2 class="mb-4 text-primary">Casos Activos</h2>
 
  <!-- Spinner -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary"></div>
  </div>

  <!-- Filtros -->
  <div *ngIf="!loading && casos.length" class="row mb-3 g-2">
    <div class="col-md-6">
      <input
        type="text"
        class="form-control"
        placeholder="Buscar por cliente, expediente o código..."
        [(ngModel)]="textoBuscar"
        (input)="aplicarFiltros()"
      />
    </div>

    <div class="col-md-3">
      <select
        class="form-select"
        [(ngModel)]="filtroEstado"
        (change)="aplicarFiltros()"
      >
        <option value="">Todos los estados</option>
        <option value="pendiente_documentos">Pendiente Documentos</option>
        <option value="en_tramite">En Trámite</option>
        <option value="completado">Completado</option>
      </select>
      
    </div>
     <div class="col-md-3">
    <a class="btn btn-info" [routerLink]="['/casos/nuevo']">
    <i class="fas fa-plus me-1"></i> Añadir Caso
  </a>
    </div>
  </div>

  <!-- Tabla -->
  <div *ngIf="!loading && paginatedCasos.length" class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Trámite</th>
          <th>Estado</th>
          <th>Expediente / Código</th>
          <th>Última Actualización</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let caso of paginatedCasos">
          <td>{{ caso.id }}</td>

          <td>
            {{ caso.cliente?.nombre ?? '-' }}
            {{ caso.cliente?.apellido ?? '' }}
          </td>

          <td>{{ caso.tipoTramite?.descripcion ?? '-' }}</td>

          <td>
            <span [ngClass]="getBadgeClass(caso.estado)">
              {{ caso.estado | titlecase }}
            </span>
          </td>

          <td>
            {{ caso.num_expediente }} / {{ caso.cod_caso }}
          </td>

          <td>
            {{ caso.fecha_estado ? (caso.fecha_estado | date:'short') : '-' }}
          </td>

          <td>
            <!-- Ver caso -->
            <button
              type="button"
              class="btn btn-info btn-sm me-1"
              (click)="verCaso(caso)"
            >
              <i class="fas fa-eye"></i>
            </button>

            <!-- Editar -->
            <button
              type="button"
              class="btn btn-warning btn-sm me-1"
              (click)="editarCaso(caso)"
            >
              <i class="fas fa-edit"></i>
            </button>

            <!-- Ver historial -->
            <button
              type="button"
              class="btn btn-dark btn-sm"
              (click)="verHistorial(caso)"
              style="cursor:pointer"
            >
              <i class="fas fa-clock"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Paginación -->
    <nav *ngIf="totalPages > 1">
      <ul class="pagination pagination-sm justify-content-center mt-3 flex-wrap">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" href="#" (click)="prevPage($event)">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>

        <li
          class="page-item"
          *ngFor="let page of pages"
          [class.active]="page === currentPage"
        >
          <a class="page-link" href="#" (click)="goToPage(page, $event)">
            {{ page }}
          </a>
        </li>

        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" href="#" (click)="nextPage($event)">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- No hay casos -->
  <div *ngIf="!loading && !casosFiltrados.length" class="alert alert-info">
    No hay casos disponibles.
  </div>
</div>

<!-- ================= MODAL HISTORIAL ================= -->

<div
  class="modal fade show d-block"
  tabindex="-1"
  *ngIf="historialCaso"
  style="background: rgba(0,0,0,0.5)"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">
          Historial del Caso #{{ historialCaso.id }}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="cerrarModalHistorial()"
        ></button>
      </div>

      <div class="modal-body">

        <div *ngIf="!historial.length" class="alert alert-info">
          No hay historial registrado.
        </div>

        <table *ngIf="historial.length" class="table table-sm table-bordered">
          <thead class="table-light">
            <tr>
              <th>Estado Anterior</th>
              <th>Estado Nuevo</th>
              <th>Usuario</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historial">
              <td>{{ item.estado_anterior }}</td>
              <td>{{ item.estado_nuevo }}</td>
              <td>{{ item.usuario_id }}</td>
              <td>{{ item.fecha_cambio | date:'short' }}</td>
            </tr>
          </tbody>
        </table>

      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="cerrarModalHistorial()"
        >
          Cerrar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Ver -->

<!-- MODAL VER CASO -->
<div class="modal fade show"
     *ngIf="mostrarModalVer"
     style="display:block; background: rgba(0,0,0,0.5);">

  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg">

      <!-- Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          Detalles del Caso #{{ casoSeleccionado?.id }}
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                (click)="cerrarModalVer()">
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body" *ngIf="casoSeleccionado">

        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Cliente:</strong><br>
            {{ casoSeleccionado.cliente?.nombre }}
            {{ casoSeleccionado.cliente?.apellido }}
          </div>

          <div class="col-md-6">
            <strong>Trámite:</strong><br>
            {{ casoSeleccionado.tipoTramite?.descripcion }}
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Estado:</strong><br>
            <span [ngClass]="getBadgeClass(casoSeleccionado.estado)">
              {{ casoSeleccionado.estado | titlecase }}
            </span>
          </div>

          <div class="col-md-6">
            <strong>Expediente / Código:</strong><br>
            {{ casoSeleccionado.num_expediente }} /
            {{ casoSeleccionado.cod_caso }}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <strong>Última Actualización:</strong><br>
            {{ casoSeleccionado.fecha_estado | date:'short' }}
          </div>
        </div>

      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary"
                type="button"
                (click)="cerrarModalVer()">
          Cerrar
        </button>
      </div>

    </div>
  </div>
</div>

